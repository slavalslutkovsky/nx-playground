apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mydatabase-prod

resources:
  - ../../base
  - pdb.yaml

namePrefix: prod-

# Production-specific patches
patches:
  # CNPG Cluster: 3 instances for HA
  - patch: |-
      - op: replace
        path: /spec/instances
        value: 3
      - op: replace
        path: /spec/storage/size
        value: 50Gi
      - op: replace
        path: /spec/resources/requests/memory
        value: 1Gi
      - op: replace
        path: /spec/resources/requests/cpu
        value: 500m
      - op: replace
        path: /spec/resources/limits/memory
        value: 2Gi
      - op: replace
        path: /spec/resources/limits/cpu
        value: 2000m
      - op: replace
        path: /spec/postgresql/parameters/shared_buffers
        value: 512MB
      - op: replace
        path: /spec/postgresql/parameters/effective_cache_size
        value: 1536MB
      - op: replace
        path: /spec/postgresql/parameters/max_connections
        value: "200"
      - op: replace
        path: /spec/bootstrap/initdb/secret/name
        value: prod-mydatabase-db-credentials
    target:
      kind: Cluster
      name: mydatabase-db

  # AtlasMigration: update references to match namePrefix
  - patch: |-
      - op: replace
        path: /spec/urlFrom/secretKeyRef/name
        value: prod-mydatabase-db-app
      - op: replace
        path: /spec/dir/configMapRef/name
        value: prod-mydatabase-migrations
    target:
      kind: AtlasMigration
      name: mydatabase-migration

# Production should use external secrets management (external-secrets, sealed-secrets, etc.)
# The secret 'prod-mydatabase-db-credentials' must be created separately with:
#   - username: database username
#   - password: strong randomly generated password
#
# Example with kubectl (NOT recommended for real prod):
#   kubectl create secret generic prod-mydatabase-db-credentials \
#     --from-literal=username=mydatabase \
#     --from-literal=password=$(openssl rand -base64 32) \
#     -n mydatabase-prod
