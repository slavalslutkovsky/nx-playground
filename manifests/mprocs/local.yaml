# Local Docker development workflow
# Usage: just dev (or: mprocs -c manifests/mprocs/local.yaml)
# For Kind/Kubernetes workflow: just dev-kind

procs:
  # =============================================================================
  # Local Docker Development
  # Uses docker-compose for infrastructure, bacon for Rust hot-reload
  # =============================================================================

  # Infrastructure + DB setup (combined)
  # infra:
  #   shell: |
  #     echo "Starting Docker infrastructure..."
  #     docker compose -f manifests/dockers/compose.yaml up -d
  #     echo "Waiting for PostgreSQL..."
  #     until docker exec dockers-postgres-1 pg_isready -U myuser -q 2>/dev/null; do
  #       sleep 1
  #     done
  #     echo "Creating database..."
  #     docker exec dockers-postgres-1 psql -U myuser -d postgres -c "CREATE DATABASE mydatabase;" 2>/dev/null || true
  #     echo "Running migrations..."
  #     atlas migrate apply --dir "file://manifests/migrations/mydatabase" --url "postgres://myuser:mypassword@localhost:5432/mydatabase?sslmode=disable"
  #     echo "Infrastructure ready! Tailing logs..."
  #     docker compose -f manifests/dockers/compose.yaml logs -f
  #   stop: "SIGTERM"

  # =============================================================================
  # Rust Services (bacon for hot-reload)
  # Note: Start these manually after infra is ready (press 's' to start)
  # =============================================================================
  zerg-api:
    shell: "DATABASE_URL='postgres://myuser:mypassword@localhost:5432/mydatabase' bacon zerg-api"
    stop: "SIGTERM"
    # autostart: false

  zerg-tasks:
    shell: "DATABASE_URL='postgres://myuser:mypassword@localhost:5432/mydatabase' bacon zerg-tasks"
    stop: "SIGTERM"
    # autostart: false

  zerg-email:
    shell: "bacon zerg-email-nats"
    stop: "SIGTERM"
    # autostart: false

  # =============================================================================
  # Frontend
  # =============================================================================
  zerg-web:
    shell: "bun nx dev zerg-web"
    stop: "SIGTERM"
    # autostart: false
