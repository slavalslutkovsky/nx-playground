apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-clone
spec:
  description: Clone the repository
  params:
  - name: repo-url
    type: string
    description: Git repository URL
  - name: revision
    type: string
    description: Git revision
    default: main
  steps:
  - name: clone
    image: alpine/git:latest
    script: "\n                    git clone $(params.repo-url) $(workspaces.source.path)\n                    cd $(workspaces.source.path)\n                    git checkout $(params.revision)\n                "
  workspaces:
  - name: source
    description: Workspace to clone into
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: install-deps
spec:
  description: Install project dependencies
  steps:
  - name: install
    image: oven/bun:1
    script: "\n                    bun install\n                "
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: nx-lint
spec:
  description: Run nx lint
  params:
  - name: affected
    type: string
    default: 'true'
  steps:
  - name: nx-lint
    image: oven/bun:1
    script: "\n                        if [ \"$(params.affected)\" = \"true\" ]; then\n                            bun nx affected -t lint\n                        else\n                            bun nx run-many -t lint\n                        fi\n                    "
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: nx-test
spec:
  description: Run nx test
  params:
  - name: affected
    type: string
    default: 'true'
  steps:
  - name: nx-test
    image: oven/bun:1
    script: "\n                        if [ \"$(params.affected)\" = \"true\" ]; then\n                            bun nx affected -t test\n                        else\n                            bun nx run-many -t test\n                        fi\n                    "
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: nx-build
spec:
  description: Run nx build
  params:
  - name: affected
    type: string
    default: 'true'
  steps:
  - name: nx-build
    image: oven/bun:1
    script: "\n                        if [ \"$(params.affected)\" = \"true\" ]; then\n                            bun nx affected -t build\n                        else\n                            bun nx run-many -t build\n                        fi\n                    "
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: nx-playground-ci
spec:
  description: CI pipeline for nx-playground
  params:
  - name: repo-url
    type: string
    description: Git repository URL
  - name: revision
    type: string
    default: main
  tasks:
  - name: clone
    taskRef:
      name: git-clone
    params:
    - name: repo-url
      value: $(params.repo-url)
    - name: revision
      value: $(params.revision)
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: install
    taskRef:
      name: install-deps
    runAfter:
    - clone
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: lint
    taskRef:
      name: nx-lint
    runAfter:
    - install
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: test
    taskRef:
      name: nx-test
    runAfter:
    - install
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: build
    taskRef:
      name: nx-build
    runAfter:
    - lint
    - test
    workspaces:
    - name: source
      workspace: shared-workspace
  workspaces:
  - name: shared-workspace
