apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-clone
spec:
  description: Clone the repository
  params:
  - name: repo-url
    type: string
    description: Git repository URL
  - name: revision
    type: string
    description: Git revision
    default: main
  steps:
  - name: clone
    image: alpine/git:latest
    script: |
      git clone $(params.repo-url) $(workspaces.source.path)
      cd $(workspaces.source.path)
      git checkout $(params.revision)
  workspaces:
  - name: source
    description: Workspace to clone into
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: install-deps
spec:
  description: Install project dependencies
  steps:
  - name: install
    image: oven/bun:1
    script: bun install
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: nx-lint
spec:
  description: Run nx lint
  params:
  - name: affected
    type: string
    default: 'true'
  steps:
  - name: nx-lint
    image: oven/bun:1
    script: |
      if [ "$(params.affected)" = "true" ]; then
          bun nx affected -t lint
      else
          bun nx run-many -t lint
      fi
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: nx-test
spec:
  description: Run nx test
  params:
  - name: affected
    type: string
    default: 'true'
  steps:
  - name: nx-test
    image: oven/bun:1
    script: |
      if [ "$(params.affected)" = "true" ]; then
          bun nx affected -t test
      else
          bun nx run-many -t test
      fi
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: nx-build
spec:
  description: Run nx build
  params:
  - name: affected
    type: string
    default: 'true'
  steps:
  - name: nx-build
    image: oven/bun:1
    script: |
      if [ "$(params.affected)" = "true" ]; then
          bun nx affected -t build
      else
          bun nx run-many -t build
      fi
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: nx-playground-ci
spec:
  description: CI pipeline for nx-playground
  params:
  - name: repo-url
    type: string
    description: Git repository URL
  - name: revision
    type: string
    default: main
  tasks:
  - name: clone
    taskRef:
      name: git-clone
      kind: Task
    params:
    - name: repo-url
      value: $(params.repo-url)
    - name: revision
      value: $(params.revision)
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: install
    taskRef:
      name: install-deps
      kind: Task
    runAfter:
    - clone
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: lint
    taskRef:
      name: nx-lint
      kind: Task
    runAfter:
    - install
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: test
    taskRef:
      name: nx-test
      kind: Task
    runAfter:
    - install
    workspaces:
    - name: source
      workspace: shared-workspace
  - name: build
    taskRef:
      name: nx-build
      kind: Task
    runAfter:
    - lint
    - test
    workspaces:
    - name: source
      workspace: shared-workspace
  workspaces:
  - name: shared-workspace
