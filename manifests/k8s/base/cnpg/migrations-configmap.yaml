# Migration ConfigMap for Atlas Operator
# Auto-generated by: just cnpg-gen-migrations
# Do not edit manually!
apiVersion: v1
kind: ConfigMap
metadata:
  name: mydatabase-migrations
  labels:
    app.kubernetes.io/name: mydatabase-migrations
    app.kubernetes.io/component: migration
data:
  20240204000001_initial.sql: |
    -- Initial Database Schema (Consolidated Best Practices - Lean)
    -- PostgreSQL 17+ required for uuidv7()
    -- Indexes: Only essential ones. Add more based on actual query patterns.
    
    -- =============================================================================
    -- Extensions
    -- =============================================================================
    CREATE EXTENSION IF NOT EXISTS pgcrypto;
    
    -- =============================================================================
    -- Schemas
    -- =============================================================================
    CREATE SCHEMA IF NOT EXISTS util;
    
    -- =============================================================================
    -- Utility Functions
    -- =============================================================================
    CREATE OR REPLACE FUNCTION util.touch_updated_at()
    RETURNS trigger AS $$
    BEGIN
      NEW.updated_at = NOW();
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    
    -- =============================================================================
    -- Enum Types
    -- =============================================================================
    CREATE TYPE task_priority AS ENUM ('low', 'medium', 'high', 'urgent');
    CREATE TYPE task_status AS ENUM ('todo', 'in_progress', 'done');
    CREATE TYPE cloud_provider AS ENUM ('aws', 'gcp', 'azure');
    CREATE TYPE environment AS ENUM ('development', 'staging', 'production');
    CREATE TYPE project_status AS ENUM ('provisioning', 'active', 'suspended', 'deleting', 'archived');
    CREATE TYPE resource_type AS ENUM ('compute', 'storage', 'database', 'network', 'serverless', 'analytics', 'other');
    CREATE TYPE resource_status AS ENUM ('creating', 'active', 'updating', 'deleting', 'deleted', 'failed');
    
    -- =============================================================================
    -- Tables
    -- =============================================================================
    
    -- Users table
    CREATE TABLE users (
      id UUID PRIMARY KEY DEFAULT uuidv7(),
      email VARCHAR(255) NOT NULL,
      name VARCHAR(255) NOT NULL,
      password_hash VARCHAR(255) NOT NULL,
      avatar_url TEXT,
      roles TEXT[] NOT NULL DEFAULT ARRAY['user'::text],
      email_verified BOOLEAN NOT NULL DEFAULT false,
      is_active BOOLEAN NOT NULL DEFAULT true,
      is_locked BOOLEAN NOT NULL DEFAULT false,
      failed_login_attempts INTEGER NOT NULL DEFAULT 0,
      locked_until TIMESTAMPTZ,
      last_login_at TIMESTAMPTZ,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );
    
    CREATE UNIQUE INDEX idx_users_email ON users(email);
    
    -- OAuth accounts table
    CREATE TABLE oauth_accounts (
      id UUID PRIMARY KEY DEFAULT uuidv7(),
      user_id UUID NOT NULL,
      provider VARCHAR(50) NOT NULL,
      provider_user_id VARCHAR(255) NOT NULL,
      provider_username VARCHAR(255),
      email VARCHAR(255),
      display_name VARCHAR(255),
      avatar_url TEXT,
      access_token TEXT,
      refresh_token TEXT,
      token_expires_at TIMESTAMPTZ,
      scopes TEXT[],
      raw_user_data JSONB,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      CONSTRAINT fk_oauth_accounts_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    
    CREATE UNIQUE INDEX idx_oauth_provider_user ON oauth_accounts(provider, provider_user_id);
    CREATE INDEX idx_oauth_accounts_user_id ON oauth_accounts(user_id);
    
    -- Projects table
    CREATE TABLE projects (
      id UUID PRIMARY KEY DEFAULT uuidv7(),
      name VARCHAR(255) NOT NULL,
      user_id UUID NOT NULL,
      description TEXT NOT NULL DEFAULT '',
      cloud_provider cloud_provider NOT NULL,
      region VARCHAR(255) NOT NULL,
      environment environment NOT NULL DEFAULT 'development',
      status project_status NOT NULL DEFAULT 'provisioning',
      budget_limit DOUBLE PRECISION,
      tags JSONB NOT NULL DEFAULT '{}',
      enabled BOOLEAN NOT NULL DEFAULT true,
      repository_url VARCHAR(500),
      dam VARCHAR(500) DEFAULT 'aris',
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      CONSTRAINT fk_projects_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    
    CREATE INDEX idx_projects_user_id ON projects(user_id);
    
    -- Tasks table
    CREATE TABLE tasks (
      id UUID PRIMARY KEY DEFAULT uuidv7(),
      title VARCHAR(255) NOT NULL,
      description TEXT NOT NULL DEFAULT '',
      completed BOOLEAN NOT NULL DEFAULT false,
      project_id UUID,
      priority task_priority NOT NULL DEFAULT 'medium',
      status task_status NOT NULL DEFAULT 'todo',
      due_date TIMESTAMPTZ,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      CONSTRAINT fk_tasks_project FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE SET NULL
    );
    
    CREATE INDEX idx_tasks_project_id ON tasks(project_id);
    
    -- Cloud resources table
    CREATE TABLE cloud_resources (
      id UUID PRIMARY KEY DEFAULT uuidv7(),
      project_id UUID NOT NULL,
      name VARCHAR(255) NOT NULL,
      resource_type resource_type NOT NULL,
      status resource_status NOT NULL DEFAULT 'creating',
      region VARCHAR(255) NOT NULL,
      configuration JSONB NOT NULL DEFAULT '{}',
      cost_per_hour DOUBLE PRECISION,
      monthly_cost_estimate DOUBLE PRECISION,
      tags JSONB NOT NULL DEFAULT '{}',
      enabled BOOLEAN NOT NULL DEFAULT true,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      deleted_at TIMESTAMPTZ,
      CONSTRAINT fk_cloud_resources_project FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    );
    
    CREATE INDEX idx_cloud_resources_project_id ON cloud_resources(project_id);
    CREATE UNIQUE INDEX unique_resource_name_per_project ON cloud_resources(project_id, name);
    
    -- =============================================================================
    -- Triggers
    -- =============================================================================
    CREATE TRIGGER users_touch_updated_at
      BEFORE UPDATE ON users
      FOR EACH ROW
      EXECUTE FUNCTION util.touch_updated_at();
    
    CREATE TRIGGER oauth_accounts_touch_updated_at
      BEFORE UPDATE ON oauth_accounts
      FOR EACH ROW
      EXECUTE FUNCTION util.touch_updated_at();
    
    CREATE TRIGGER projects_touch_updated_at
      BEFORE UPDATE ON projects
      FOR EACH ROW
      EXECUTE FUNCTION util.touch_updated_at();
    
    CREATE TRIGGER tasks_touch_updated_at
      BEFORE UPDATE ON tasks
      FOR EACH ROW
      EXECUTE FUNCTION util.touch_updated_at();
    
    CREATE TRIGGER cloud_resources_touch_updated_at
      BEFORE UPDATE ON cloud_resources
      FOR EACH ROW
      EXECUTE FUNCTION util.touch_updated_at();
  20240204000002_seed_data.sql: |
    -- Seed data for local development
    -- This file populates the database with sample data for testing
    
    -- =============================================================================
    -- Seed Users
    -- =============================================================================
    -- Password hash is bcrypt of "password123" for testing purposes
    INSERT INTO users (id, email, name, password_hash, roles, email_verified, is_active, created_at, updated_at)
    VALUES
        (
            '01930b3c-7c5f-7000-8000-000000000001',
            'admin@example.com',
            'Admin User',
            '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.VTtYxFyL8rKYmK',
            ARRAY['user', 'admin'],
            true,
            true,
            NOW(),
            NOW()
        ),
        (
            '01930b3c-7c5f-7001-8000-000000000002',
            'user@example.com',
            'Regular User',
            '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.VTtYxFyL8rKYmK',
            ARRAY['user'],
            true,
            true,
            NOW(),
            NOW()
        ),
        (
            '01930b3c-7c5f-7001-8000-000000000099',
            'developer@example.com',
            'Developer User',
            '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.VTtYxFyL8rKYmK',
            ARRAY['user', 'developer'],
            true,
            true,
            NOW(),
            NOW()
        )
    ON CONFLICT (id) DO NOTHING;
    
    -- =============================================================================
    -- Seed OAuth Accounts (linked to developer user)
    -- =============================================================================
    INSERT INTO oauth_accounts (
        id, user_id, provider, provider_user_id, provider_username, email,
        display_name, created_at, updated_at
    )
    VALUES
        (
            '01930b3c-7c5f-7100-8000-000000000101',
            '01930b3c-7c5f-7001-8000-000000000099',
            'github',
            'gh_12345',
            'developer',
            'developer@example.com',
            'Developer User',
            NOW(),
            NOW()
        )
    ON CONFLICT (id) DO NOTHING;
    
    -- =============================================================================
    -- Seed Projects
    -- =============================================================================
    INSERT INTO projects (
        id, name, user_id, description, cloud_provider, region,
        environment, status, budget_limit, tags, enabled, created_at, updated_at
    )
    VALUES
        (
            '01930b3c-7c5f-7002-8000-000000000003',
            'playground-monorepo',
            '01930b3c-7c5f-7001-8000-000000000002',
            'Main development playground for experimenting with Rust and Kubernetes',
            'aws',
            'us-east-1',
            'development',
            'active',
            100.0,
            '{}'::JSONB,
            true,
            NOW(),
            NOW()
        ),
        (
            '01930b3c-7c5f-7003-8000-000000000004',
            'zerg-api-production',
            '01930b3c-7c5f-7001-8000-000000000002',
            'Production deployment of Zerg API services',
            'aws',
            'us-west-2',
            'production',
            'active',
            500.0,
            '{"team": "platform", "criticality": "high"}'::JSONB,
            true,
            NOW(),
            NOW()
        ),
        (
            '01930b3c-7c5f-7004-8000-000000000005',
            'ml-training-cluster',
            '01930b3c-7c5f-7000-8000-000000000001',
            'Machine learning model training infrastructure',
            'gcp',
            'us-central1',
            'development',
            'provisioning',
            1000.0,
            '{"type": "ml", "gpu": "true"}'::JSONB,
            true,
            NOW(),
            NOW()
        )
    ON CONFLICT (id) DO NOTHING;
    
    -- =============================================================================
    -- Seed Cloud Resources (using enum types)
    -- =============================================================================
    INSERT INTO cloud_resources (
        id, project_id, name, resource_type, status, region,
        configuration, cost_per_hour, monthly_cost_estimate, tags,
        enabled, created_at, updated_at, deleted_at
    )
    VALUES
        (
            '01930b3c-7c5f-7005-8000-000000000006',
            '01930b3c-7c5f-7002-8000-000000000003',
            'dev-postgres-primary',
            'database'::resource_type,
            'active'::resource_status,
            'us-east-1',
            '{"instance_type": "db.t3.medium", "engine": "postgres", "version": "15.3"}'::JSONB,
            0.068,
            48.96,
            '{"backup": "daily"}'::JSONB,
            true,
            NOW(),
            NOW(),
            NULL
        ),
        (
            '01930b3c-7c5f-7006-8000-000000000007',
            '01930b3c-7c5f-7002-8000-000000000003',
            'dev-redis-cache',
            'database'::resource_type,
            'active'::resource_status,
            'us-east-1',
            '{"instance_type": "cache.t3.micro", "engine": "redis", "version": "7.0"}'::JSONB,
            0.017,
            12.24,
            '{}'::JSONB,
            true,
            NOW(),
            NOW(),
            NULL
        ),
        (
            '01930b3c-7c5f-7007-8000-000000000008',
            '01930b3c-7c5f-7003-8000-000000000004',
            'prod-api-loadbalancer',
            'network'::resource_type,
            'active'::resource_status,
            'us-west-2',
            '{"type": "application", "scheme": "internet-facing", "ssl": true}'::JSONB,
            0.025,
            18.0,
            '{"public": "true"}'::JSONB,
            true,
            NOW(),
            NOW(),
            NULL
        ),
        (
            '01930b3c-7c5f-7008-8000-000000000009',
            '01930b3c-7c5f-7004-8000-000000000005',
            'ml-gpu-cluster',
            'compute'::resource_type,
            'creating'::resource_status,
            'us-central1',
            '{"instance_type": "n1-standard-16", "gpu": "nvidia-tesla-v100", "gpu_count": 4}'::JSONB,
            12.5,
            9000.0,
            '{"gpu": "v100", "count": "4"}'::JSONB,
            true,
            NOW(),
            NOW(),
            NULL
        )
    ON CONFLICT (id) DO NOTHING;
    
    -- =============================================================================
    -- Seed Tasks
    -- =============================================================================
    INSERT INTO tasks (
        id, title, description, completed, project_id, priority, status,
        due_date, created_at, updated_at
    )
    VALUES
        (
            '01930b3c-7c5f-7009-8000-000000000010',
            'Setup CI/CD pipeline',
            'Configure GitHub Actions for automated testing and deployment',
            false,
            '01930b3c-7c5f-7002-8000-000000000003',
            'high'::task_priority,
            'in_progress'::task_status,
            NOW() + INTERVAL '7 days',
            NOW(),
            NOW()
        ),
        (
            '01930b3c-7c5f-700a-8000-000000000011',
            'Implement OAuth authentication',
            'Add Google and GitHub OAuth support with PKCE',
            true,
            '01930b3c-7c5f-7003-8000-000000000004',
            'high'::task_priority,
            'done'::task_status,
            NOW() - INTERVAL '2 days',
            NOW() - INTERVAL '5 days',
            NOW()
        ),
        (
            '01930b3c-7c5f-700b-8000-000000000012',
            'Database migration cleanup',
            'Consolidate and optimize database migrations',
            true,
            '01930b3c-7c5f-7002-8000-000000000003',
            'medium'::task_priority,
            'done'::task_status,
            NOW(),
            NOW() - INTERVAL '1 day',
            NOW()
        ),
        (
            '01930b3c-7c5f-700c-8000-000000000013',
            'Setup monitoring and alerts',
            'Configure Prometheus and Grafana for production monitoring',
            false,
            '01930b3c-7c5f-7003-8000-000000000004',
            'high'::task_priority,
            'todo'::task_status,
            NOW() + INTERVAL '14 days',
            NOW(),
            NOW()
        ),
        (
            '01930b3c-7c5f-700d-8000-000000000014',
            'Optimize API performance',
            'Profile and optimize slow API endpoints, add caching',
            false,
            '01930b3c-7c5f-7003-8000-000000000004',
            'medium'::task_priority,
            'todo'::task_status,
            NOW() + INTERVAL '21 days',
            NOW(),
            NOW()
        ),
        (
            '01930b3c-7c5f-700e-8000-000000000015',
            'ML model training infrastructure',
            'Setup distributed training pipeline with GPU cluster',
            false,
            '01930b3c-7c5f-7004-8000-000000000005',
            'urgent'::task_priority,
            'in_progress'::task_status,
            NOW() + INTERVAL '10 days',
            NOW() - INTERVAL '3 days',
            NOW()
        )
    ON CONFLICT (id) DO NOTHING;
  20240205000001_add_project_repository.sql: |
    -- -- Add repository URL for project source code link
    -- ALTER TABLE projects ADD COLUMN repository_url VARCHAR(500);
  20240205000002_add_oauth_ids_to_users.sql: |
    -- Add OAuth provider IDs to users table for backward compatibility
    -- The oauth_accounts table handles detailed OAuth data, but these columns
    -- provide quick lookup for OAuth login flow
    
    ALTER TABLE users ADD COLUMN google_id VARCHAR(255);
    ALTER TABLE users ADD COLUMN github_id VARCHAR(255);
    
    CREATE UNIQUE INDEX idx_users_google_id ON users(google_id) WHERE google_id IS NOT NULL;
    CREATE UNIQUE INDEX idx_users_github_id ON users(github_id) WHERE github_id IS NOT NULL;
  atlas.sum: |
    h1:KD5uSuB7QL10gogOT5Nj2S/bQF0YfGw72SySqC+iot4=
    20240204000001_initial.sql h1:u07XlR0qsAD1ogWJZiKZ6pDZQnBDD9UQyPyJrkX596M=
    20240204000002_seed_data.sql h1:ssYU9LX1KYd+uCnBT/yxDD0FBO+eHM1bbtiQUuKOPD0=
    20240205000001_add_project_repository.sql h1:6O783DxdxOHCxRy/jkDMMEf9YP3E6/xiDqN3AX1MqLg=
    20240205000002_add_oauth_ids_to_users.sql h1:zzhxjvX3kOVm5m9mne5efoMCfaLbg6pKETul3Vt/qM4=
