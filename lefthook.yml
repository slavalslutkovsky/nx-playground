# Lefthook - Git hooks manager
# https://github.com/evilmartians/lefthook

# Pre-commit: Fast checks before each commit
pre-commit:
  parallel: true
  commands:
    # TypeScript/JavaScript formatting & linting
    biome-check:
      glob: "*.{js,ts,tsx,json}"
      run: bunx biome check --no-errors-on-unmatched {staged_files}
      stage_fixed: true

    # Rust formatting check
    rustfmt:
      glob: "*.rs"
      run: cargo fmt -- --check

    # Rust linting
    clippy:
      glob: "*.rs"
      run: cargo clippy --workspace -- -D warnings

    # Schema diagram generation (only when entities change)
    schema-gen:
      glob: "libs/domains/*/src/entity.rs"
      run: cargo run --bin schema-gen && git add docs/schema.md docs/schema.dbml
    doc-deg:
      glob: "docs/schema.dbml"
      run: cargo doc --workspace --no-deps --document-private-items
    cargo-check:
      glob: "*.rs"
      run: cargo check

# Pre-push: Thorough checks before pushing
pre-push:
  parallel: true
  commands:
    # Rust tests
    cargo-test:
      run: cargo test --workspace

    # Nx affected checks
    nx-affected-lint:
      run: bun nx affected --target=lint --base=origin/main

    nx-affected-test:
      run: bun nx affected --target=test --base=origin/main

    nx-affected-build:
      run: bun nx affected --target=build --base=origin/main

    # Security audit
#    cargo-deny:
#      run: cargo deny check

# Post-checkout: Sync after switching branches
post-checkout:
  commands:
    deps-sync:
      run: bun install --frozen-lockfile 2>/dev/null || true

# Post-merge: Sync after pulling/merging
post-merge:
  commands:
    deps-update:
      run: bun install --frozen-lockfile 2>/dev/null || true

# Commit message: Enforce conventional commits
commit-msg:
  commands:
    conventional:
      run: |
        msg=$(cat "{1}")
        if ! echo "$msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\(.+\))?: .+"; then
          echo "Commit message must follow Conventional Commits format"
          echo "Example: feat(api): add user authentication"
          echo "Got: $msg"
          exit 1
        fi
