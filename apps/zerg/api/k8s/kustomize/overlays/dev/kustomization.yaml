apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: zerg

resources:
  - ../../base
  # Include core infrastructure (shared ConfigMap, Ingress)
  # Note: Apply k8s/core/overlays/dev separately or include here
  # - ../../../../../k8s/core/overlays/dev

patches:
  # Add secrets reference and app-specific env vars
  - patch: |-
      - op: add
        path: /spec/template/spec/containers/0/envFrom/-
        value:
          secretRef:
            name: zerg-shared-secrets
            optional: true
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: APP_ENV
          value: "development"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: zerg-shared-secrets
              key: JWT_SECRET
              optional: true
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GOOGLE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: zerg-shared-secrets
              key: GOOGLE_CLIENT_ID
              optional: true
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GOOGLE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: zerg-shared-secrets
              key: GOOGLE_CLIENT_SECRET
              optional: true
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GITHUB_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: zerg-shared-secrets
              key: GITHUB_CLIENT_ID
              optional: true
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GITHUB_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: zerg-shared-secrets
              key: GITHUB_CLIENT_SECRET
              optional: true
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: FLAGSMITH_ENVIRONMENT_KEY
          valueFrom:
            secretKeyRef:
              name: zerg-shared-secrets
              key: FLAGSMITH_ENVIRONMENT_KEY
              optional: true
    target:
      kind: Deployment
      name: zerg-api
  # Single replica for dev
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      name: zerg-api
