apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: zerg-email-nats
  labels:
    app: zerg-email-nats
spec:
  scaleTargetRef:
    name: zerg-email-nats
  minReplicaCount: 0          # Scale to zero when no emails in queue
  maxReplicaCount: 10
  pollingInterval: 5          # Check queue every 5 seconds (faster for workers)
  cooldownPeriod: 60          # Scale down faster for workers (1 min)
  triggers:
    # NATS JetStream: scale based on pending messages
    - type: nats-jetstream
      metadata:
        natsServerMonitoringEndpoint: "nats.dbs.svc.cluster.local:8222"
        account: "$G"                    # Global account
        stream: "EMAILS"                 # Stream name from EmailNatsStream
        consumer: "email-processor"      # Consumer name
        lagThreshold: "10"               # Scale up when > 10 pending messages
        activationLagThreshold: "1"      # Wake from zero when > 1 message
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 60   # Faster scale down for workers
          policies:
            - type: Percent
              value: 50                    # Can reduce by 50%
              periodSeconds: 30
        scaleUp:
          stabilizationWindowSeconds: 0    # Immediate scale up
          policies:
            - type: Pods
              value: 5                     # Add up to 5 pods at once
              periodSeconds: 15
