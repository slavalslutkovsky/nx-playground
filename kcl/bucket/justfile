#!/usr/bin/env just --justfile

# KCL Multi-Cloud Storage Management
# Manages AWS S3, GCP Cloud Storage, and Azure Blob Storage via Crossplane

default:
    @just -l

# ============================================================================
# Variables
# ============================================================================

kcl_dir := justfile_directory()
functions_dir := kcl_dir / "functions/storage"
tests_dir := kcl_dir / "tests"
examples_dir := kcl_dir / "examples"
apis_dir := kcl_dir / "apis"

# Provider labels
label_aws := "cloud.provider/aws=true"
label_gcp := "cloud.provider/gcp=true"
label_azure := "cloud.provider/azure=true"

# ============================================================================
# Development - Lint, Format, Validate
# ============================================================================

# Lint all KCL files
lint:
    @echo "=== Linting KCL files ==="
    kcl lint {{functions_dir}}/...
    kcl lint {{tests_dir}}/unit/...

# Format all KCL files
fmt:
    @echo "=== Formatting KCL files ==="
    kcl fmt {{functions_dir}}/...
    kcl fmt {{tests_dir}}/unit/...
    kcl fmt {{tests_dir}}/stress/...

# Check KCL syntax without executing
check:
    @echo "=== Checking KCL syntax ==="
    kcl {{functions_dir}}/main.k -n
    kcl {{functions_dir}}/composition.k -n

# Validate all files (lint + check)
validate: lint check
    @echo "=== All validations passed ==="

# ============================================================================
# Testing
# ============================================================================

# Run all unit tests
test-unit:
    @echo "=== Running Unit Tests ==="
    kcl {{tests_dir}}/unit/test_storage.k
    @echo "Unit tests completed!"

# Run stress tests
test-stress:
    @echo "=== Running Stress Tests ==="
    time kcl {{tests_dir}}/stress/stress_test.k
    @echo "Stress tests completed!"

# Run integration tests (requires cluster)
test-integration: _check-kubectl
    @echo "=== Running Integration Tests ==="
    kubectl apply -f {{tests_dir}}/integration/test_aws.yaml --dry-run=server
    kubectl apply -f {{tests_dir}}/integration/test_gcp.yaml --dry-run=server
    kubectl apply -f {{tests_dir}}/integration/test_azure.yaml --dry-run=server
    kubectl apply -f {{tests_dir}}/integration/test_multicloud.yaml --dry-run=server
    @echo "Integration tests completed!"

# Run all tests
test: test-unit test-stress
    @echo "=== All tests passed ==="

# ============================================================================
# Running / Rendering
# ============================================================================

# Render KCL function output (dry-run)
render:
    @echo "=== Rendering Storage Function ==="
    kcl {{functions_dir}}/main.k

# Render AWS example
render-aws:
    @echo "=== Rendering AWS Example ==="
    kcl {{functions_dir}}/composition.k -D 'params={"oxr": {"metadata": {"name": "test-aws", "labels": {"cloud.provider/aws": "true"}}, "spec": {"parameters": {"location": "us-east-1"}}}}'

# Render GCP example
render-gcp:
    @echo "=== Rendering GCP Example ==="
    kcl {{functions_dir}}/composition.k -D 'params={"oxr": {"metadata": {"name": "test-gcp", "labels": {"cloud.provider/gcp": "true"}}, "spec": {"parameters": {"location": "US"}}}}'

# Render Azure example
render-azure:
    @echo "=== Rendering Azure Example ==="
    kcl {{functions_dir}}/composition.k -D 'params={"oxr": {"metadata": {"name": "test-azure", "labels": {"cloud.provider/azure": "true"}}, "spec": {"parameters": {"location": "eastus", "azure": {"resourceGroup": "test-rg"}}}}}'

# Render multi-cloud example
render-multi:
    @echo "=== Rendering Multi-Cloud Example ==="
    kcl {{functions_dir}}/composition.k -D 'params={"oxr": {"metadata": {"name": "test-multi", "labels": {"cloud.provider/aws": "true", "cloud.provider/gcp": "true", "cloud.provider/azure": "true"}}, "spec": {"parameters": {"location": "us-east-1", "azure": {"resourceGroup": "test-rg"}}}}}'

# Render all providers
render-all: render-aws render-gcp render-azure render-multi

# ============================================================================
# Provider-Specific Operations
# ============================================================================

# Apply AWS claim to cluster
apply-aws: _check-kubectl
    @echo "=== Applying AWS Claim ==="
    kubectl apply -f {{examples_dir}}/aws/claim.yaml

# Apply GCP claim to cluster
apply-gcp: _check-kubectl
    @echo "=== Applying GCP Claim ==="
    kubectl apply -f {{examples_dir}}/gcp/claim.yaml

# Apply Azure claim to cluster
apply-azure: _check-kubectl
    @echo "=== Applying Azure Claim ==="
    kubectl apply -f {{examples_dir}}/azure/claim.yaml

# Apply multi-cloud claim to cluster
apply-multi: _check-kubectl
    @echo "=== Applying Multi-Cloud Claim ==="
    kubectl apply -f {{examples_dir}}/multi-cloud/claim.yaml

# Apply all examples
apply-all: apply-aws apply-gcp apply-azure apply-multi

# Delete AWS claim
delete-aws: _check-kubectl
    kubectl delete -f {{examples_dir}}/aws/claim.yaml --ignore-not-found

# Delete GCP claim
delete-gcp: _check-kubectl
    kubectl delete -f {{examples_dir}}/gcp/claim.yaml --ignore-not-found

# Delete Azure claim
delete-azure: _check-kubectl
    kubectl delete -f {{examples_dir}}/azure/claim.yaml --ignore-not-found

# Delete multi-cloud claim
delete-multi: _check-kubectl
    kubectl delete -f {{examples_dir}}/multi-cloud/claim.yaml --ignore-not-found

# Delete all examples
delete-all: delete-aws delete-gcp delete-azure delete-multi

# ============================================================================
# Crossplane Operations
# ============================================================================

# Install XRD and Composition
install: _check-kubectl
    @echo "=== Installing Crossplane Resources ==="
    kubectl apply -f {{apis_dir}}/storagebuckets/definition.yaml
    kubectl apply -f {{apis_dir}}/storagebuckets/composition.yaml
    @echo "Installation complete!"

# Uninstall XRD and Composition
uninstall: _check-kubectl
    @echo "=== Uninstalling Crossplane Resources ==="
    kubectl delete -f {{apis_dir}}/storagebuckets/composition.yaml --ignore-not-found
    kubectl delete -f {{apis_dir}}/storagebuckets/definition.yaml --ignore-not-found
    @echo "Uninstallation complete!"

# Get all storage buckets
get-buckets: _check-kubectl
    kubectl get storagebuckets.platform.yurikrupnik.com -A

# Describe storage bucket
describe-bucket name: _check-kubectl
    kubectl describe storagebucket {{name}}

# Get buckets by provider label
get-aws-buckets: _check-kubectl
    kubectl get storagebuckets.platform.yurikrupnik.com -A -l {{label_aws}}

get-gcp-buckets: _check-kubectl
    kubectl get storagebuckets.platform.yurikrupnik.com -A -l {{label_gcp}}

get-azure-buckets: _check-kubectl
    kubectl get storagebuckets.platform.yurikrupnik.com -A -l {{label_azure}}

# Get composed resources for a bucket
get-composed name: _check-kubectl
    @echo "=== Composed Resources for {{name}} ==="
    kubectl get managed -l crossplane.io/claim-name={{name}}

# ============================================================================
# Stress Testing
# ============================================================================

# Run stress test with custom bucket count
stress count="100":
    @echo "=== Running Stress Test with {{count}} buckets per provider ==="
    kcl {{tests_dir}}/stress/stress_test.k -D "BUCKET_COUNT={{count}}"

# Benchmark KCL rendering performance
bench:
    @echo "=== Benchmarking KCL Rendering ==="
    @echo "--- Small (10 buckets) ---"
    time kcl {{tests_dir}}/stress/stress_test.k -D "BUCKET_COUNT=10" > /dev/null
    @echo ""
    @echo "--- Medium (50 buckets) ---"
    time kcl {{tests_dir}}/stress/stress_test.k -D "BUCKET_COUNT=50" > /dev/null
    @echo ""
    @echo "--- Large (100 buckets) ---"
    time kcl {{tests_dir}}/stress/stress_test.k -D "BUCKET_COUNT=100" > /dev/null
    @echo ""
    @echo "--- XLarge (500 buckets) ---"
    time kcl {{tests_dir}}/stress/stress_test.k -D "BUCKET_COUNT=500" > /dev/null

# Memory profile stress test
stress-profile count="100":
    @echo "=== Memory Profile: {{count}} buckets per provider ==="
    /usr/bin/time -l kcl {{tests_dir}}/stress/stress_test.k -D "BUCKET_COUNT={{count}}" > /dev/null 2>&1 || \
    /usr/bin/time -v kcl {{tests_dir}}/stress/stress_test.k -D "BUCKET_COUNT={{count}}" > /dev/null 2>&1

# ============================================================================
# Upbound/Build Operations
# ============================================================================

# Build the Upbound project
build:
    @echo "=== Building Upbound Project ==="
    cd {{kcl_dir}} && up project build

# Push to Upbound registry
push:
    @echo "=== Pushing to Upbound Registry ==="
    cd {{kcl_dir}} && up project push

# Generate KCL models from providers
generate-models:
    @echo "=== Generating KCL Models ==="
    cd {{kcl_dir}} && up project generate

# ============================================================================
# Utility Commands
# ============================================================================

# Show project structure
tree:
    @echo "=== Project Structure ==="
    tree {{kcl_dir}} -I '.up|.git|__pycache__' --dirsfirst

# Watch for changes and re-run tests
watch:
    @echo "=== Watching for changes ==="
    watchexec -e k,yaml -- just test-unit

# Clean generated files
clean:
    @echo "=== Cleaning generated files ==="
    rm -rf {{kcl_dir}}/.up/build
    @echo "Clean complete!"

# Show help
help:
    @echo "KCL Multi-Cloud Storage Management"
    @echo ""
    @echo "Provider Labels:"
    @echo "  cloud.provider/aws=true    - Target AWS S3"
    @echo "  cloud.provider/gcp=true    - Target GCP Cloud Storage"
    @echo "  cloud.provider/azure=true  - Target Azure Blob Storage"
    @echo ""
    @echo "Quick Start:"
    @echo "  just validate      - Lint and check all KCL files"
    @echo "  just test          - Run unit and stress tests"
    @echo "  just render-all    - Render all provider examples"
    @echo "  just install       - Install XRD and Composition"
    @echo "  just apply-aws     - Deploy AWS example"
    @echo ""
    @echo "Use 'just -l' for full command list"

# ============================================================================
# Internal Helpers
# ============================================================================

# Check if kubectl is available
_check-kubectl:
    @which kubectl > /dev/null || (echo "Error: kubectl not found" && exit 1)
