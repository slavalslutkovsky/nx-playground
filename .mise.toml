[settings]
experimental = true
legacy_version_file = true

[env]
# Load secrets from .env file (gitignored)
_.file = ".env"
_.path = ["./node_modules/.bin", "./target/debug"]
MIGRATION_DIR = "libs/migration"
DATABASE_SCHEMA = "public"
RUST_LOG = "info,zerg_api=debug,tower_http=debug,sea_orm=info"
RUST_ENV = "development"
APP_ENV = "development"
PORT = "8080"

[tools]
# Core
#just = "latest"
#bun = "latest"
#node = "24"
#go = "1.23"
#
## Kubernetes
#kubectl = "1.35"
#helm = "3.16"
#kustomize = "5.5"
#kind = "0.31.0"
#tilt = "0.36.1"
#
## Platform
#kcl = "0.12.3"
#buf = "1.64.0"
#
## Cargo tools (compiled from source - slow first install, cached after)
#"cargo:cargo-nextest" = "latest"
#"cargo:cargo-audit" = "latest"
#"cargo:cargo-deny" = "latest"
#"cargo:bacon" = "latest"
#"cargo:sea-orm-cli" = "latest"
#
## Optional (nushell installed via homebrew)
#kompose = "1.35"

# CI validation
actionlint = "latest"

# =============================================================================
# Nx Tasks (monorepo-wide)
# =============================================================================

[tasks.nx]
description = "Run any nx command (e.g., mise run nx affected -t lint)"
run = "bun nx $@"

[tasks.nx-lint]
description = "Lint affected projects"
run = "bun nx affected -t lint $@"

[tasks.nx-test]
description = "Test affected projects"
run = "bun nx affected -t test $@"

[tasks.nx-build]
description = "Build affected projects"
run = "bun nx affected -t build $@"

[tasks.nx-all]
description = "Lint, test, build affected"
run = "bun nx affected -t lint test build $@"

[tasks.nx-run]
description = "Run target on project (e.g., mise run nx-run zerg-api:build)"
run = "bun nx run $@"

[tasks.nx-lint-all]
description = "Lint all projects"
run = "bun nx run-many -t lint $@"

[tasks.nx-test-all]
description = "Test all projects"
run = "bun nx run-many -t test $@"

[tasks.nx-build-all]
description = "Build all projects"
run = "bun nx run-many -t build $@"

[tasks.nx-graph]
description = "Open Nx project graph"
run = "bun nx graph"

[tasks.install]
description = "Install dependencies"
run = "bun install"

# =============================================================================
# Rust Tasks
# =============================================================================

[tasks.cargo]
description = "Run any cargo command (e.g., mise run cargo build -p zerg-api)"
run = "cargo $@"

[tasks.cargo-check]
description = "Full Rust quality check"
depends = ["cargo-fmt-check", "cargo-lint", "cargo-test", "cargo-audit"]

[tasks.cargo-fmt-check]
description = "Check Rust formatting"
run = "cargo fmt --all --check"

[tasks.cargo-fmt]
description = "Format Rust code"
run = "cargo fmt --all"

[tasks.cargo-lint]
description = "Run Clippy lints"
run = "cargo clippy --workspace --all-targets -- -D warnings"

[tasks.cargo-test]
description = "Run Rust tests with nextest"
run = "cargo nextest run --workspace $@"

[tasks.cargo-audit]
description = "Rust security audit"
run = ["cargo audit --ignore RUSTSEC-2023-0071", "cargo deny check --config .cargo/deny.toml"]

# =============================================================================
# Dependency Updates
# =============================================================================

[tasks.update]
description = "Update all lockfiles (Cargo.lock + bun.lock)"
run = ["cargo update", "bun update"]

[tasks.upgrade]
description = "Upgrade all deps to latest versions"
run = ["cargo upgrade --workspace --incompatible", "cargo update", "bun update --latest"]

[tasks.cargo-update]
description = "Update Cargo.lock"
run = "cargo update"

[tasks.cargo-upgrade]
description = "Upgrade Cargo.toml to latest (requires cargo-edit)"
run = ["cargo upgrade --incompatible", "cargo update"]

[tasks.bun-update]
description = "Update bun.lock"
run = "bun update"

[tasks.bun-upgrade]
description = "Upgrade bun packages to latest"
run = "bun update --latest"

[tasks.outdated]
description = "Show outdated dependencies"
run = ["cargo outdated --workspace || true", "bun outdated || true"]

# =============================================================================
# Combined Tasks
# =============================================================================

[tasks.check]
description = "Full quality check (nx + rust)"
depends = ["nx-all", "cargo-check"]

[tasks.lint]
description = "Lint all (nx + rust)"
depends = ["nx-lint", "cargo-lint"]

[tasks.test]
description = "Test all (nx + rust)"
depends = ["nx-test", "cargo-test"]

[tasks.build]
description = "Build all (nx + rust)"
depends = ["nx-build"]

[tasks.proto]
description = "Full proto workflow"
depends = ["proto-fmt", "proto-lint", "proto-build", "proto-gen"]

[tasks.proto-fmt]
description = "Format proto files"
dir = "manifests/grpc"
run = "buf format -w"

[tasks.proto-lint]
description = "Lint proto files"
dir = "manifests/grpc"
run = "buf lint"

[tasks.proto-build]
description = "Build proto files"
dir = "manifests/grpc"
run = "buf build"

[tasks.proto-gen]
description = "Generate code from proto"
dir = "manifests/grpc"
run = "buf generate"

[tasks.up]
description = "Start development environment"
run = "nu scripts/nu/mod.nu up"

[tasks.down]
description = "Stop development environment"
run = "nu scripts/nu/mod.nu down"

[tasks.web]
description = "Run web dev server"
dir = "apps/zerg/web"
run = "bun run dev"

[tasks.migrate]
description = "Run database migrations"
run = "cargo run -p migration -- up"

[tasks.dam]
run = "docker ps"

# =============================================================================
# CI Generation Tasks
# =============================================================================

[tasks.ci-gen]
description = "Generate all CI resources"
dir = "scripts/kcl/ci"
run = """
kcl run main.k -S githubWorkflow > ../../../.github/workflows/ci-generated.yml
mkdir -p ../../../manifests/tekton
kcl run main.k -S tektonResources > ../../../manifests/tekton/ci-pipeline.yaml
"""

[tasks.ci-gen-github]
description = "Generate GitHub Actions only"
dir = "scripts/kcl/ci"
run = "kcl run main.k -S githubWorkflow > ../../../.github/workflows/ci-generated.yml"

[tasks.ci-gen-tekton]
description = "Generate Tekton resources only"
dir = "scripts/kcl/ci"
run = """
mkdir -p ../../../manifests/tekton
kcl run main.k -S tektonResources > ../../../manifests/tekton/ci-pipeline.yaml
"""

[tasks.ci-validate]
description = "Validate CI generation"
dir = "scripts/kcl/ci"
run = "kcl run main.k"

[tasks.ci-show-github]
description = "Preview GitHub Actions output"
dir = "scripts/kcl/ci"
run = "kcl run main.k -S githubWorkflow"

[tasks.ci-show-tekton]
description = "Preview Tekton output"
dir = "scripts/kcl/ci"
run = "kcl run main.k -S tektonResources"

[tasks.ci-lint]
description = "Validate GitHub Actions workflows"
run = "actionlint .github/workflows/*.yml"

[tasks.ci-lint-generated]
description = "Validate generated GitHub Actions workflow"
run = "actionlint .github/workflows/ci-generated.yml"

[tasks.ci-gen-and-validate]
description = "Generate and validate CI"
run = ["kcl run main.k -S githubWorkflow > ../../../.github/workflows/ci-generated.yml", "actionlint ../../../.github/workflows/ci-generated.yml"]
dir = "scripts/kcl/ci"

# =============================================================================
# Schema Generation Tasks
# =============================================================================

[tasks.schema]
description = "Generate all schema formats (Mermaid, DBML, Atlas)"
run = "cargo run -p schema-gen"

[tasks.schema-mermaid]
description = "Generate Mermaid diagram only"
run = "cargo run -p schema-gen -- --format mermaid"

[tasks.schema-dbml]
description = "Generate DBML diagram only"
run = "cargo run -p schema-gen -- --format dbml"

[tasks.schema-atlas]
description = "Generate Atlas HCL schema"
run = "cargo run -p schema-gen -- --format atlas"

# =============================================================================
# Atlas Database Tasks (requires atlas CLI)
# =============================================================================

[tasks.atlas-diff]
description = "Show schema diff against database"
run = "atlas schema diff --from 'file://docs/schema.hcl' --to 'postgres://myuser:mypassword@localhost:5432/mydatabase?sslmode=disable'"

[tasks.atlas-apply]
description = "Apply schema changes to database"
run = "atlas schema apply --url 'postgres://myuser:mypassword@localhost:5432/mydatabase?sslmode=disable' --to 'file://docs/schema.hcl'"

[tasks.atlas-inspect]
description = "Inspect current database schema"
run = "atlas schema inspect --url 'postgres://myuser:mypassword@localhost:5432/mydatabase?sslmode=disable'"

[tasks.atlas-plan]
description = "Generate migration plan from schema diff"
run = "atlas schema plan --from 'postgres://myuser:mypassword@localhost:5432/mydatabase?sslmode=disable' --to 'file://docs/schema.hcl' --dev-url 'docker://postgres/16'"

[tasks.atlas-lint]
description = "Lint the Atlas schema file"
run = "atlas schema lint --dev-url 'docker://postgres/16' 'file://docs/schema.hcl'"

# =============================================================================
# Atlas Kubernetes Operator Tasks
# =============================================================================

[tasks.atlas-operator-install]
description = "Install Atlas Operator in Kubernetes"
run = "helm install atlas-operator oci://ghcr.io/ariga/charts/atlas-operator --namespace atlas-operator --create-namespace"

[tasks.atlas-operator-upgrade]
description = "Upgrade Atlas Operator"
run = "helm upgrade atlas-operator oci://ghcr.io/ariga/charts/atlas-operator --namespace atlas-operator"

[tasks.atlas-k8s-dev]
description = "Deploy Atlas schema to dev cluster"
run = "kubectl apply -k manifests/atlas/overlays/dev"

[tasks.atlas-k8s-prod]
description = "Deploy Atlas schema to prod cluster"
run = "kubectl apply -k manifests/atlas/overlays/prod"

[tasks.atlas-k8s-status]
description = "Check Atlas schema status in cluster"
run = "kubectl get atlasschemas -A -o wide"

[tasks.atlas-sync-schema]
description = "Sync docs/schema.hcl to Kubernetes ConfigMap manifest"
run = """
echo "Syncing schema.hcl to ConfigMap..."
cat > manifests/atlas/base/schema-configmap.yaml << 'HEREDOC'
# This ConfigMap is auto-generated by: mise run atlas-sync-schema
# Do not edit manually - changes will be overwritten
apiVersion: v1
kind: ConfigMap
metadata:
  name: zerg-schema
  namespace: zerg
  labels:
    app.kubernetes.io/name: zerg-schema
    app.kubernetes.io/component: database
data:
  schema.hcl: |
HEREDOC
sed 's/^/    /' docs/schema.hcl >> manifests/atlas/base/schema-configmap.yaml
echo "Done! ConfigMap updated at manifests/atlas/base/schema-configmap.yaml"
"""

[tasks.atlas-gen-and-sync]
description = "Generate Atlas schema and sync to K8s ConfigMap"
depends = ["schema-atlas", "atlas-sync-schema"]
