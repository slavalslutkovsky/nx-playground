apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xapplication
  labels:
    crossplane.io/xrd: xapplications.platform.io
spec:
  compositeTypeRef:
    apiVersion: platform.io/v1alpha1
    kind: XApplication
  mode: Pipeline
  pipeline:
    - step: compose-application
      functionRef:
        name: function-kcl
      input:
        apiVersion: krm.kcl.dev/v1alpha1
        kind: KCLRun
        metadata:
          name: compose-application
        spec:
          target: Default
          # OCI dependencies - models generated by 'up project generate', schemas published to registry
          dependencies: |
            model = { oci = "oci://docker.io/yurikrupnik/platform-models", tag = "0.0.1" }
            schemas = { oci = "oci://docker.io/yurikrupnik/platform-schemas", tag = "0.0.1" }

          source: |
            """
            Application composition.
            Creates XBucket and XDatabase child composite resources.
            """
            
            import schemas.application as schema
            import schemas.helpers as h
            
            # Crossplane function inputs
            oxr = option("params").oxr
            _ocds = option("params").ocds
            dxr = option("params").dxr
            dcds = option("params").dcds
            
            # Type-annotated spec extraction
            _raw_spec = oxr.spec
            _storage_config = _raw_spec.storage or {}
            _database_config = _raw_spec.database or {}
            
            _spec: schema.ApplicationSpec = schema.ApplicationSpec {
                provider = _raw_spec.provider
                name = _raw_spec.name
                region = _raw_spec.region
                environment = _raw_spec.environment or "dev"
                deletionPolicy = _raw_spec.deletionPolicy or "Delete"
                storage = schema.StorageConfig {
                    enabled = _storage_config.enabled if "enabled" in _storage_config else True
                    storageClass = _storage_config.storageClass or "standard"
                }
                database = schema.DatabaseConfig {
                    enabled = _database_config.enabled if "enabled" in _database_config else True
                    engine = _database_config.engine or "postgres"
                    size = _database_config.size or "small"
                }
            }
            
            # Use typed spec
            _name = _spec.name
            _provider = _spec.provider
            _region = _spec.region
            _env = _spec.environment
            _deletion_policy = _spec.deletionPolicy
            
            # Storage configuration
            _storage_enabled = _spec.storage.enabled
            _storage_class = _spec.storage.storageClass
            
            # Database configuration
            _db_enabled = _spec.database.enabled
            _db_engine = _spec.database.engine
            _db_size = _spec.database.size
            
            # Composed resources
            _items = []
            
            # Create XBucket if storage is enabled
            if _storage_enabled:
                _items += [{
                    apiVersion = "storage.platform.io/v1alpha1"
                    kind = "XBucket"
                    metadata = h.metadata("${_name}-storage")
                    spec = {
                        provider = _provider
                        region = _region
                        name = "${_name}-data"
                        environment = _env
                        storageClass = _storage_class
                        deletionPolicy = _deletion_policy
                    }
                }]
            
            # Create XDatabase if database is enabled
            if _db_enabled:
                _items += [{
                    apiVersion = "database.platform.io/v1alpha1"
                    kind = "XDatabase"
                    metadata = h.metadata("${_name}-database")
                    spec = {
                        provider = _provider
                        region = _region
                        engine = _db_engine
                        size = _db_size
                        environment = _env
                        deletionPolicy = _deletion_policy
                    }
                }]
            
            # Update composite resource status
            _status: schema.ApplicationStatus = schema.ApplicationStatus {
                provider = _provider
                region = _region
                bucketName = "${_name}-data" if _storage_enabled else ""
            }
            
            _dxr = {
                **oxr
                status = _status
            }
            
            _items += [_dxr]
            
            # Output items
            items = _items
    - step: auto-ready
      functionRef:
        name: function-auto-ready
